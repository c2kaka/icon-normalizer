# Icon Normalizer 架构图和调用链

## 1. 整体架构图

```mermaid
graph TB
    subgraph "用户层"
        CLI[命令行界面]
        Web[Web界面<br/>未来扩展]
    end
    
    subgraph "应用层"
        Processor[IconProcessor<br/>业务协调器]
        Config[配置管理器]
    end
    
    subgraph "核心服务层"
        AI[AIAnalysisEngine<br/>AI分析引擎]
        Duplicate[DuplicateDetector<br/>重复检测器]
        Progress[进度跟踪器]
    end
    
    subgraph "工具层"
        FileUtil[FileUtils<br/>文件工具]
        SVGUtil[SVGUtils<br/>SVG工具]
        CryptoUtil[CryptoUtils<br/>加密工具]
    end
    
    subgraph "外部服务"
        OpenAI[OpenAI GPT-4 Vision]
        FileSystem[文件系统]
    end
    
    CLI --> Processor
    Web --> Processor
    Processor --> Config
    
    Processor --> AI
    Processor --> Duplicate
    Processor --> Progress
    
    AI --> OpenAI
    Duplicate --> CryptoUtil
    
    AI --> FileUtil
    AI --> SVGUtil
    Duplicate --> FileUtil
    
    Processor --> FileUtil
    Processor --> SVGUtil
    
    FileUtil --> FileSystem
    SVGUtil --> FileSystem
```

## 2. 详细组件架构

```mermaid
graph LR
    subgraph "CLI接口层"
        C1[Commander.js]
        C2[Chalk<br/>颜色输出]
        C3[Ora<br/>进度显示]
    end
    
    subgraph "业务逻辑层"
        B1[IconProcessor<br/>主处理器]
        B2[ProcessOptions<br/>处理选项]
        B3[ProcessResult<br/>处理结果]
    end
    
    subgraph "AI分析层"
        A1[AIAnalysisEngine<br/>AI引擎]
        A2[PromptBuilder<br/>提示词构建]
        A3[ResponseParser<br/>响应解析]
        A4[BatchProcessor<br/>批量处理]
    end
    
    subgraph "数据处理层"
        D1[DuplicateDetector<br/>重复检测]
        D2[ExactMatcher<br/>精确匹配]
        D3[SimilarityCalculator<br/>相似度计算]
        D4[ReportGenerator<br/>报告生成]
    end
    
    subgraph "文件操作层"
        F1[FileUtils<br/>文件工具]
        F2[SVGUtils<br/>SVG工具]
        F3[CryptoUtils<br/>加密工具]
        F4[MetadataManager<br/>元数据管理]
    end
    
    C1 --> B1
    B1 --> A1
    B1 --> D1
    B1 --> B2
    
    A1 --> A2
    A1 --> A3
    A1 --> A4
    A1 --> F1
    A1 --> F2
    
    D1 --> D2
    D1 --> D3
    D1 --> D4
    D1 --> F3
    D1 --> F1
    
    F1 --> F4
    F2 --> F4
```

## 3. 数据流图

```mermaid
sequenceDiagram
    participant U as 用户
    participant C as CLI
    participant P as IconProcessor
    participant F as FileUtils
    participant D as DuplicateDetector
    participant A as AIAnalysisEngine
    participant S as SVGUtils
    participant O as OpenAI API
    
    U->>C: 执行命令 process ./icons
    C->>P: processDirectory(inputDir)
    
    P->>F: scanDirectory(inputDir)
    F-->>P: SVG文件列表
    
    P->>F: createBackup(文件列表)
    F-->>P: 备份完成
    
    P->>F: 批量读取文件
    F-->>P: IconInfo数组
    
    P->>D: findDuplicates(icons)
    D->>D: 精确重复检测
    D->>D: 相似重复检测
    D-->>P: DuplicateGroup数组
    
    P->>A: batchAnalyze(唯一图标)
    A->>A: 构建提示词
    A->>O: 调用AI API
    O-->>A: 分析结果
    A->>A: 解析响应
    A-->>P: 分析结果Map
    
    P->>S: embedMetadata()
    S-->>P: 带元数据的SVG
    
    P->>F: 保存文件
    F-->>P: 保存完成
    
    P->>D: generateReport()
    D-->>P: 重复报告
    
    P-->>C: ProcessingResult
    C-->>U: 显示结果
```

## 4. 详细调用链

```mermaid
graph TD
    A[CLI: icon-normalizer process ./icons] --> B[IconProcessor.processDirectory()]
    
    B --> C1[FileUtils.scanDirectory()]
    C1 --> D[SVG文件列表]
    
    B --> C2[创建备份目录]
    C2 --> E[备份原始文件]
    
    B --> C3[加载图标信息]
    C3 --> F[IconInfo数组]
    
    B --> C4[DuplicateDetector.findDuplicates()]
    C4 --> G1[精确重复检测]
    G1 --> G11[计算文件哈希]
    G11 --> G12[按哈希分组]
    G12 --> G13[生成重复组]
    
    C4 --> G2[相似重复检测]
    G2 --> G21[两两比较]
    G21 --> G22[计算相似度]
    G22 --> G23[阈值过滤]
    G23 --> G24[生成分组]
    
    G1 --> H[DuplicateGroup数组]
    G2 --> H
    
    B --> C5[AIAnalysisEngine.batchAnalyze()]
    C5 --> I1[批量处理控制]
    I1 --> I2[analyzeIcon()]
    I2 --> I21[构建提示词]
    I21 --> I22[转换SVG格式]
    I22 --> I23[调用OpenAI API]
    I23 --> I24[解析JSON响应]
    I24 --> I25[返回AIResponse]
    
    I2 --> J[分析结果Map]
    
    B --> C6[处理结果]
    C6 --> K1[SVGUtils.embedMetadata()]
    K1 --> K11[添加XML注释]
    K11 --> K12[嵌入分类信息]
    
    C6 --> K2[FileUtils.writeFile()]
    K2 --> K21[保存到输出目录]
    K21 --> K22[创建子目录]
    
    C6 --> K3[生成报告]
    K3 --> K31[DuplicateDetector.generateReport()]
    K31 --> K32[保存到文件]
    
    B --> L[返回ProcessingResult]
```

## 5. 模块依赖关系图

```mermaid
graph TB
    subgraph "入口模块"
        CLI[src/cli/index.ts]
    end
    
    subgraph "主处理器"
        Processor[src/processor/icon-processor.ts]
    end
    
    subgraph "核心引擎"
        AIEngine[src/core/ai-engine.ts]
        DupDetector[src/core/duplicate-detector.ts]
    end
    
    subgraph "工具模块"
        FileUtils[src/utils/file-utils.ts]
        SVGUtils[src/utils/svg-utils.ts]
        CryptoUtils[src/utils/crypto-utils.ts]
    end
    
    subgraph "配置和类型"
        Config[src/config/index.ts]
        Types[src/types/index.ts]
    end
    
    subgraph "第三方依赖"
        OpenAI[openai]
        Commander[commander]
        Chalk[chalk]
        Ora[ora]
        FsExtra[fs-extra]
        XML2JS[xml2js]
    end
    
    CLI --> Processor
    CLI --> Config
    
    Processor --> AIEngine
    Processor --> DupDetector
    Processor --> FileUtils
    Processor --> SVGUtils
    Processor --> Config
    Processor --> Types
    
    AIEngine --> Config
    AIEngine --> Types
    AIEngine --> OpenAI
    
    DupDetector --> Types
    DupDetector --> CryptoUtils
    
    FileUtils --> Types
    FileUtils --> FsExtra
    
    SVGUtils --> Types
    SVGUtils --> XML2JS
    
    CryptoUtils --> Types
    
    CLI --> Commander
    CLI --> Chalk
    CLI --> Ora
```

## 6. 数据结构关系图

```mermaid
classDiagram
    class ProcessingResult {
        +totalIcons: number
        +processedIcons: number
        +duplicates: DuplicateGroup[]
        +processingTime: number
        +errors: string[]
    }
    
    class DuplicateGroup {
        +master: IconInfo
        +duplicates: IconInfo[]
        +similarity: number
        +recommendation: string
    }
    
    class IconInfo {
        +id: string
        +filename: string
        +path: string
        +content: string
        +size: number
        +hash: string
    }
    
    class AIResponse {
        +category: string
        +tags: string[]
        +confidence: number
        +reasoning: string
    }
    
    class AnalysisResult {
        +id: string
        +category: string
        +confidence: number
        +tags: string[]
        +duplicates: string[]
        +metadata: Metadata
    }
    
    class Metadata {
        +processedAt: Date
        +version: string
        +similarity: number
    }
    
    ProcessingResult "1" *-- "many" DuplicateGroup
    DuplicateGroup "1" *-- "1" IconInfo
    DuplicateGroup "1" *-- "many" IconInfo
    IconInfo "1" -- "1" AnalysisResult
    AnalysisResult "1" -- "1" Metadata
    AIResponse --> AnalysisResult
```

## 7. 状态转换图

```mermaid
stateDiagram-v2
    [*] --> 扫描文件: 开始处理
    扫描文件 --> 创建备份: 找到SVG文件
    创建备份 --> 加载图标: 备份完成
    加载图标 --> 重复检测: 图标信息加载完成
    
    重复检测 --> AI分析: 检测完成
    重复检测 --> 处理结果: 无重复
    
    AI分析 --> 处理结果: 分析完成
    处理结果 --> 保存文件: 结果处理完成
    
    保存文件 --> 生成报告: 文件保存完成
    生成报告 --> [*]: 处理完成
    
    state 重复检测 {
        [*] --> 精确检测
        精确检测 --> 相似检测
        相似检测 --> [*]
    }
    
    state AI分析 {
        [*] --> 构建提示词
        构建提示词 --> 调用API
        调用API --> 解析响应
        解析响应 --> [*]
    }
```

## 8. 错误处理流程

```mermaid
graph TD
    A[开始处理] --> B{文件是否存在?}
    B -->|是| C{文件格式正确?}
    B -->|否| D[记录错误: 文件不存在]
    C -->|是| E{API密钥配置?}
    C -->|否| F[记录错误: 格式错误]
    
    E -->|是| G[调用AI API]
    E -->|否| H[记录错误: API密钥缺失]
    
    G --> I{API调用成功?}
    I -->|是| J[解析响应]
    I -->|否| K[记录错误: API调用失败]
    
    J --> L{解析成功?}
    L -->|是| M[继续处理]
    L -->|否| N[记录错误: 解析失败]
    
    D --> O[继续下一个文件]
    F --> O
    H --> O
    K --> O
    N --> O
    M --> P[处理完成]
    
    O --> Q{还有文件?}
    Q -->|是| B
    Q -->|否| P
```

这些图表展示了 Icon Normalizer 的完整架构、调用链和数据流，可以帮助开发者更好地理解系统结构和各个模块之间的关系。
# 图像预处理功能说明

## 概述

为了提高大模型对图标的分类准确性，我们实现了完整的图像预处理流程。该流程会在将SVG转换为PNG并发送给AI模型之前，对图像进行标准化处理。

## 功能特性

### 1. 透明通道处理
- **功能**: 将透明背景的图标合成到统一的浅灰色背景上
- **目的**: 避免透明区域导致的特征缺失
- **实现**: 使用 Sharp 的 `flatten()` 功能，保留边缘锐度

### 2. 统一尺寸与填充
- **目标尺寸**: 默认 384×384 像素（可配置）
- **缩放策略**: 
  - 保持原始宽高比
  - 短边对齐到目标尺寸
  - 不进行过度缩小（避免信息损失）
- **填充方式**: 使用背景色等距填充到正方形
- **插值算法**: 使用 Lanczos3 高质量插值，保持边缘锐度

### 3. 自动裁剪留白
- **功能**: 自动检测并裁剪多余的留白区域
- **安全边距**: 保留 10 像素的安全边距（可配置）
- **裁剪阈值**: 默认 250（0-255范围，接近白色的像素会被视为背景）

### 4. 颜色与对比度
- **策略**: 轻度标准化，保证图标颜色语义保真
- **背景色**: 默认使用浅灰色 RGB(245, 245, 245)，避免纯白色

## 配置选项

在 `src/config/index.ts` 中，新增了 `imagePreprocess` 配置项：

```typescript
imagePreprocess: {
  enabled: true,                           // 是否启用图像预处理
  targetSize: 384,                         // 目标尺寸（正方形边长）
  backgroundColor: { r: 245, g: 245, b: 245 }, // 背景颜色（浅灰色）
  padding: 10,                             // 安全边距（像素）
  autoCrop: true,                          // 是否启用自动裁剪留白
  cropThreshold: 250,                      // 裁剪阈值（0-255）
}
```

### 环境变量配置（可选）

您可以通过 `.env` 文件覆盖这些配置：

```bash
# 图像预处理配置
IMAGE_PREPROCESS_ENABLED=true
IMAGE_PREPROCESS_SIZE=384
IMAGE_PREPROCESS_BG_R=245
IMAGE_PREPROCESS_BG_G=245
IMAGE_PREPROCESS_BG_B=245
IMAGE_PREPROCESS_PADDING=10
IMAGE_PREPROCESS_AUTO_CROP=true
IMAGE_PREPROCESS_CROP_THRESHOLD=250
```

## 输出结构

处理完成后，会在 `processed/<模型名称>/` 目录下生成以下内容：

```
processed/
└── <模型名称>/
    ├── icons/          # 处理后的SVG文件（带元数据）
    ├── png/            # 预处理后的PNG文件（供检查）
    ├── duplicates/     # 重复的图标
    ├── analysis-summary.json  # 分析结果汇总
    └── duplicate-report.txt   # 重复报告
```

### PNG输出目录

所有预处理后的PNG图片会保存在 `processed/<模型名称>/png/` 目录下，文件名与对应的SVG文件相同（后缀改为 .png）。

这样您可以：
1. 直观地查看预处理的效果
2. 验证图像质量是否符合预期
3. 调试和优化预处理参数

## 处理流程

```
SVG 输入
    ↓
渲染为高分辨率PNG（保留细节）
    ↓
【预处理阶段】
├─ 透明通道处理（合成到背景色）
├─ 自动裁剪留白（如果启用）
├─ 统一尺寸与填充（保持比例）
└─ 输出高质量PNG
    ↓
转换为Base64
    ↓
发送给AI模型分析
    ↓
同时保存PNG到 processed/png/ 目录
```

## 文件变更清单

### 新增文件
1. **src/utils/image-preprocessor.ts** - 图像预处理核心模块
   - `ImagePreprocessor` 类：封装所有预处理逻辑
   - `PreprocessConfig` 接口：预处理配置定义
   - `preprocessImage()` 便捷函数

### 修改的文件
1. **src/utils/svg-converter.ts**
   - 集成图像预处理流程
   - 支持自定义预处理配置参数

2. **src/core/ai-engine.ts**
   - 使用新的预处理功能
   - 从配置中读取预处理参数

3. **src/core/ollama-engine.ts**
   - 统一使用预处理流程
   - 保持与 ai-engine 一致的处理方式

4. **src/processor/icon-processor.ts**
   - 新增 `savePngVersion()` 方法
   - 自动保存预处理后的PNG到 `processed/png/` 目录

5. **src/types/index.ts**
   - 在 `Config` 接口中添加 `imagePreprocess` 配置项

6. **src/config/index.ts**
   - 添加默认预处理配置

## 使用方式

### 1. 使用默认配置（推荐）

默认配置已经针对图标处理优化，直接运行即可：

```bash
yarn build
yarn start -- /path/to/icons
```

### 2. 自定义配置

如果需要调整预处理参数，修改 `.env` 文件或直接修改 `src/config/index.ts`。

### 3. 禁用预处理

如果想要对比效果，可以临时禁用预处理：

```typescript
// 在 src/config/index.ts 中
imagePreprocess: {
  enabled: false,  // 设置为 false
  // ... 其他配置
}
```

## 技术细节

### 使用的库
- **Sharp**: 高性能的图像处理库
  - 支持 SVG 渲染
  - 提供丰富的图像操作 API
  - 性能优秀，适合批量处理

### 算法选择
- **Lanczos3 插值**: 在保持边缘锐度和图像质量之间取得最佳平衡
- **自动裁剪**: 基于颜色阈值检测，自动识别内容边界
- **等距填充**: 确保图标在画布中居中显示

### 性能优化
- 批量处理时复用 ImagePreprocessor 实例
- 异步处理，支持并发
- 错误处理：单个图标失败不影响整体流程

## 预期效果

实施图像预处理后，预期能够：

1. **提高分类准确性**: 统一的图像格式让模型更容易识别特征
2. **减少误判**: 去除干扰因素（透明、留白、尺寸不一）
3. **提升一致性**: 所有图标使用相同的预处理流程
4. **便于调试**: PNG输出让您可以直观查看处理效果

## 调试和验证

### 查看预处理结果

运行处理后，检查 `processed/<模型名称>/png/` 目录：

```bash
# 查看PNG目录
ls -la processed/<模型名称>/png/

# 使用图片查看器查看效果
open processed/<模型名称>/png/
```

### 调整参数

如果效果不理想，可以调整以下参数：

- **targetSize**: 增大可保留更多细节，但会增加处理时间
- **cropThreshold**: 增大会裁剪更多留白，减小会保留更多边缘
- **padding**: 调整图标周围的安全边距
- **backgroundColor**: 尝试不同的背景色（浅灰、白色等）

## 兼容性

- ✅ 兼容 OpenAI 视觉模型（GPT-4V, GPT-4O等）
- ✅ 兼容 Ollama 本地模型（LLaVA, MiniCPM-V等）
- ✅ 向后兼容：可通过 `enabled: false` 禁用预处理

## 未来优化方向

1. 根据实际效果调整默认参数
2. 支持更多预处理选项（如对比度增强、锐化等）
3. 提供预处理效果对比工具
4. 添加批量预处理预览功能

